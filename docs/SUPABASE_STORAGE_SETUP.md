# Supabase Storage Setup Guide

This guide explains how to set up Supabase Storage for file uploads in form submissions.

## Prerequisites

- Supabase project created
- Supabase API credentials configured in `.env.local`

## Setup Steps

### 1. Create Storage Bucket

1. Go to your Supabase Dashboard
2. Navigate to **Storage** in the left sidebar
3. Click **New bucket**
4. Configure the bucket:
   - **Name**: `form-attachments`
   - **Public bucket**: ❌ **Disable** (private bucket for security)
   - **File size limit**: Set appropriate limit (e.g., 10 MB)
   - **Allowed MIME types**: Leave empty or specify (e.g., `application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document`)

5. Click **Create bucket**

### 2. Configure Bucket Policies

For production security, configure policies:

1. Go to **Storage** → **Policies** → `form-attachments`
2. Create a policy for service role uploads:

```sql
-- Allow service role to upload files
CREATE POLICY "Service Role Upload"
ON storage.objects FOR INSERT
TO service_role
WITH CHECK (bucket_id = 'form-attachments');
```

3. Create a policy for service role to read files (for generating signed URLs):

```sql
-- Allow service role to read files
CREATE POLICY "Service Role Read"
ON storage.objects FOR SELECT
TO service_role
USING (bucket_id = 'form-attachments');
```

**Note**: Files are stored privately and accessed via signed URLs generated by the admin API route. Only authenticated admin users can download files.

### 3. Verify Setup

After setup, file uploads will:
- Be stored in `form-submissions/{submissionId}/{timestamp}-{filename}`
- Have public URLs that can be accessed directly
- Be included in email notifications with download links
- Be accessible from the admin dashboard with download buttons

## File Storage Structure

```
form-attachments/ (private bucket)
└── form-submissions/
    └── {submissionId}/
        └── {timestamp}-{filename}
```

Example:
```
form-attachments/
└── form-submissions/
    └── temp-1234567890-abc123/
        └── 1234567890-resume.pdf
```

## File Access

Files are stored in a **private bucket** and accessed via:
- **Signed URLs**: Generated by `/api/files/download` endpoint
- **Authentication**: Only admin users can generate download URLs
- **Expiry**: Signed URLs expire after 1 hour
- **Security**: Files cannot be accessed directly without authentication

## Troubleshooting

### Files not uploading

1. Check that the bucket name is exactly `form-attachments`
2. Verify `SUPABASE_SERVICE_ROLE_KEY` is set correctly
3. Check Supabase logs for errors

### Files not accessible

1. Verify admin authentication is working
2. Check that service role has read permissions
3. Verify file paths are stored correctly in the database
4. Check API route logs for signed URL generation errors

### File size errors

1. Check bucket file size limit
2. Verify file is within the limit before upload
3. Consider increasing the limit if needed

## Security Considerations

- ✅ **Private bucket**: Files are not publicly accessible
- ✅ **Signed URLs**: Temporary URLs (1 hour expiry) for downloads
- ✅ **Admin authentication**: Only authenticated admins can download files
- ✅ **Unique paths**: Files stored with unique paths to prevent conflicts
- ✅ **File type restrictions**: Can be configured via bucket MIME type settings
- ⚠️ **File scanning**: Consider implementing virus scanning for production
- ⚠️ **Rate limiting**: Consider rate limiting on download endpoint
- ⚠️ **Audit logging**: Consider logging file access for security auditing

